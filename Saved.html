<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RJ's Bookmark Manager</title>
<link rel="icon" href="/Pages/favicon.png" />    
  
<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
}

body {
  font-family: Arial, sans-serif;
  font-size: 17px;
  background: #000;
  display: flex;
  flex-direction: column;
}

#sectionsContainer {
  overflow: hidden;
}

.manager-section {
  margin: 0;
  border: none;
  background: #000;
}

.manager-section.active-section {
  border-color: #0077cc;
  box-shadow: 0 0 0 2px #cce4ff;
}

.manager-title-bar {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  background: #111;
  gap: 10px;
  border-radius: 6px 6px 0 0;
}

.manager-title {
  font-size: 20px;
  font-weight: bold;
  flex: 1;
  user-select: none;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 300px;
  cursor: pointer;
}

.section-btns {
  margin-left: auto;
  display: none;
  gap: 6px;
  flex-shrink: 0;
}

.manager-title-edit {
  font-size: 20px;
  font-weight: bold;
  flex: 1;
  border: 1px solid #aaa;
  border-radius: 4px;
  padding: 2px 8px;
  outline: none;
}

.section-action-btn {
  background: none;
  border: 1px solid #444;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  padding: 4px 10px;
  color: #aaa;
  display: none;
}



.section-action-btn:hover {
  background: #222;
}

.section-action-btn.danger:hover {
  background: #fde;
  border-color: #f99;
  color: #c00;
}



.tabs, .subtabs {
  display: flex;
  overflow-x: auto;
  white-space: nowrap;
  background: #111;
  border-bottom: 1px solid #222;
}

.tabs button, .subtabs button {
  padding: 12px 18px;
  border: none;
  background: none;
  cursor: pointer;
  flex: 0 0 auto;
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 17px;
  color: #aaa;
}

.tabs button.active, .subtabs button.active {
  background: #222;
  font-weight: bold;
  color: #fff;
}

.bookmarks {
  padding: 18px;
  height: calc(100vh - 200px);
  overflow-y: auto;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
  gap: 12px;
  align-content: start;
  background: #000;
}

.bookmark-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 6px;
  border-radius: 10px;
  cursor: pointer;
  text-align: center;
}

.bookmark-item:hover {
  background: #1a1a1a;
}

.bookmark-item.selected {
  background: #003366;
}

.bookmark-item img {
  width: 36px;
  height: 36px;
  margin-bottom: 6px;
  border-radius: 8px;
}

.bookmark-item a {
  text-decoration: none;
  color: #ccc;
  font-size: 11px;
  font-weight: 500;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  word-break: break-word;
  max-width: 72px;
  line-height: 1.3;
}

#addSectionBtn {
  display: none;
  margin: 0 30px 30px 30px;
  padding: 12px 24px;
  font-size: 16px;
  background: #111;
  border: 1px dashed #444;
  border-radius: 6px;
  cursor: pointer;
  color: #888;
  width: calc(100% - 60px);
  box-sizing: border-box;
  text-align: center;
}

#addSectionBtn:hover {
  background: #1a1a1a;
  color: #fff;
}

#emptyMsg {
  text-align: center;
  color: #555;
  padding: 40px 30px 10px 30px;
  font-size: 16px;
  display: none;
}

/* Lock bar at top */
#lockBar {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 8px 30px;
  background: #1a1a1a;
  border-bottom: 1px solid #ddd;
  gap: 10px;
  position: sticky;
  top: 0;
  z-index: 100;
}

#pageTitle {
  font-size: 18px;
  font-weight: bold;
  color: #f2f2f7;
  margin-right: auto;
}



#lockBtn {
  padding: 6px 14px;
  font-size: 14px;
  border: none;
  border-radius: 4px;
  background: #1a1a1a;
  cursor: pointer;
  color: #ddd;
}

#lockBtn:hover {
  background: #333;
}

/* â”€â”€ Data Manager Popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#dataManagerOverlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

#dataManagerPopup {
  background: #2c2c2e;
  border-radius: 14px;
  width: 90%;
  max-width: 480px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  border: 1px solid #3a3a3c;
}

#dataManagerHeader {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px 18px;
  border-bottom: 1px solid #3a3a3c;
  background: #3a3a3c;
}

#dataManagerHeader strong {
  font-size: 15px;
  color: #f2f2f7;
}

#dataManagerClose {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  color: #aeaeb2;
  padding: 0 4px;
}

#dataManagerClose:hover { color: #f2f2f7; }

#dataManagerList {
  overflow-y: auto;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

#dataManagerList::-webkit-scrollbar { width: 6px; }
#dataManagerList::-webkit-scrollbar-thumb { background: #48484a; border-radius: 3px; }

.dm-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  border: 1px solid #3a3a3c;
  border-radius: 10px;
  background: #1c1c1e;
}

.dm-item-info { display: flex; flex-direction: column; gap: 2px; }

.dm-item-title {
  font-weight: 600;
  font-size: 14px;
  color: #f2f2f7;
}

.dm-item-meta {
  font-size: 12px;
  color: #8e8e93;
}

.dm-delete-btn {
  background: none;
  border: 1px solid #ff453a;
  border-radius: 6px;
  color: #ff453a;
  cursor: pointer;
  font-size: 12px;
  padding: 4px 10px;
  flex-shrink: 0;
  font-family: inherit;
}

.dm-delete-btn:hover {
  background: #ff453a;
  color: #fff;
}

.dm-empty {
  text-align: center;
  color: #636366;
  padding: 30px;
  font-size: 14px;
}

/* â”€â”€ Shared Toolbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sharedToolbar {
  position: sticky;
  top: 50px;
  z-index: 99;
  background: #2c2c2e;
  border-bottom: 1px solid #3a3a3c;
  padding: 5px 10px;
  overflow-x: auto;
  white-space: nowrap;
  flex-shrink: 0;
}

#sharedToolbar::-webkit-scrollbar { height: 3px; }
#sharedToolbar::-webkit-scrollbar-thumb { background: #48484a; }

#toolbarInner {
  display: inline-flex;
  gap: 5px;
  flex-wrap: nowrap;
  align-items: center;
}

#toolbarInner button {
  padding: 4px 11px;
  border: 1px solid #48484a;
  border-radius: 7px;
  background: #3a3a3c;
  cursor: pointer;
  font-size: 12px;
  color: #e5e5ea;
  white-space: nowrap;
  flex-shrink: 0;
  font-family: inherit;
}

#toolbarInner button:hover {
  background: #48484a;
  border-color: #636366;
  color: #fff;
}

#toolbarInner .toolbar-sep {
  width: 1px;
  height: 18px;
  background: #48484a;
  margin: 0 3px;
  flex-shrink: 0;
}

/* â”€â”€ Section Tab Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sectionTabBar {
  position: sticky;
  z-index: 98;
  display: flex;
  align-items: center;
  background: #2c2c2e;
  border-bottom: 1px solid #3a3a3c;
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
  height: 42px;
  flex-shrink: 0;
}

#sectionTabBar::-webkit-scrollbar { height: 3px; }
#sectionTabBar::-webkit-scrollbar-thumb { background: #48484a; }

#addTabBtn {
  display: none;
  align-items: center;
  justify-content: center;
  padding: 0 14px;
  font-size: 20px;
  font-weight: 300;
  color: #aeaeb2;
  cursor: pointer;
  border: none;
  background: none;
  border-right: 1px solid #3a3a3c;
  flex-shrink: 0;
  height: 100%;
}

#addTabBtn:hover {
  background: #3a3a3c;
  color: #f2f2f7;
}

.section-tab {
  display: inline-flex;
  align-items: center;
  padding: 0 18px;
  font-size: 13px;
  color: #aeaeb2;
  cursor: pointer;
  border-right: 1px solid #3a3a3c;
  flex-shrink: 0;
  max-width: 160px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  user-select: none;
  background: #2c2c2e;
  border-bottom: 2px solid transparent;
  height: 42px;
  font-family: inherit;
  transition: background 0.1s;
}

.section-tab:hover {
  background: #3a3a3c;
  color: #f2f2f7;
}

.section-tab.active {
  background: #1c1c1e;
  color: #f2f2f7;
  font-weight: 600;
  border-bottom: 2px solid #0a84ff;
}

/* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media (max-width: 600px) {
  #lockBar { padding: 0 12px; }
  #pageTitle { font-size: 13px; }
  .section-tab { padding: 0 12px; font-size: 12px; }
  .tabs button, .subtabs button { padding: 8px 12px; font-size: 12px; }
  .bookmarks { grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; padding: 12px; }
}
</style>
</head>

<body>

<div id="lockBar">
  <img src="/Pages/favicon.png" style="width:24px;height:24px;border-radius:50%;object-fit:cover;"> <span id="pageTitle">RJ's Bookmark Manager</span>
  <button id="dataManagerBtn" title="Manage Firebase Data" style="display:none;">ðŸ—„</button>
  <button id="lockBtn">ðŸ”’</button>
</div>

<!-- Data Manager Popup -->
<div id="dataManagerOverlay" style="display:none;">
  <div id="dataManagerPopup">
    <div id="dataManagerHeader">
      <strong>Firebase Data Manager</strong>
      <button id="dataManagerClose">âœ•</button>
    </div>
    <div id="dataManagerList"></div>
  </div>
</div>

<div id="sharedToolbar" style="display:none;">
  <div id="toolbarInner">
    <button data-action="add-folder">Add Folder</button>
    <button data-action="pin-folder">Pin Folder</button>
    <button data-action="delete-folder">Delete Folder</button>
    <div class="toolbar-sep"></div>
    <button data-action="add-subfolder">Add Subfolder</button>
    <button data-action="pin-subfolder">Pin Subfolder</button>
    <button data-action="delete-subfolder">Delete Subfolder</button>
    <div class="toolbar-sep"></div>
    <button data-action="add-bookmark">Add Bookmark</button>
    <button data-action="edit-bookmark">Edit Bookmark</button>
    <button data-action="delete-bookmark">Delete Bookmark</button>
    <div class="toolbar-sep"></div>
    <button data-action="move-left" title="Move section left">â—€</button>
    <button data-action="rename-section">Rename Tab</button>
    <button data-action="delete-section">Delete Tab</button>
    <button data-action="move-right" title="Move section right">â–¶</button>
  </div>
</div>

<div id="sectionTabBar">
  <button id="addTabBtn">+</button>
  <div id="sectionTabsList"></div>
</div>

<div id="sectionsContainer"></div>
<p id="emptyMsg" style="text-align:center;color:#aaa;padding:40px 30px;font-size:15px;display:none;">No sections yet. Click + to add one.</p>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA5iLF-J-WvNaYm63r8rDZU8_rtZsgwYng",
  authDomain: "my-todo-2e111.firebaseapp.com",
  databaseURL: "https://my-todo-2e111-default-rtdb.firebaseio.com",
  projectId: "my-todo-2e111",
  storageBucket: "my-todo-2e111.appspot.com",
  messagingSenderId: "765517702108",
  appId: "1:765517702108:web:2dfe7d6205040cfd2ea519"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const sectionsRef = database.ref("sectionConfig");

let sectionsConfig = [];
let managers = [];

// â”€â”€â”€ Session Lock â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CORRECT_PASSWORD = "6409";
let isUnlocked = false;

let activeManager = null;

function setActiveManager(mgr) {
  activeManager = mgr;
  // Highlight active tab
  document.querySelectorAll(".section-tab").forEach(el => el.classList.remove("active"));
  // Show only active section content
  document.querySelectorAll(".manager-section").forEach(el => el.style.display = "none");
  if (mgr) {
    mgr.container.style.display = "block";
    if (mgr.tabEl) mgr.tabEl.classList.add("active");
  }
}

function showEditButtons(visible) {
  document.getElementById("sharedToolbar").style.display = visible ? "block" : "none";
  document.getElementById("addTabBtn").style.display = visible ? "flex" : "none";
  document.getElementById("dataManagerBtn").style.display = visible ? "inline-block" : "none";
  // Update sticky top of tab bar based on toolbar visibility
  updateStickyOffsets();
}

// Wire shared toolbar buttons
document.getElementById("sharedToolbar").addEventListener("click", e => {
  const btn = e.target.closest("[data-action]");
  if (!btn) return;
  const action = btn.dataset.action;
  // Section-level actions don't need activeManager bookmark data
  if (action === "move-left") { if (activeManager) activeManager.moveSection(-1); return; }
  if (action === "move-right") { if (activeManager) activeManager.moveSection(1); return; }
  if (action === "rename-section") { if (activeManager) activeManager.renameSection(); return; }
  if (action === "delete-section") { if (activeManager) activeManager.deleteSection(); return; }
  if (!activeManager) return;
  if (action === "add-folder") activeManager.addFolder();
  else if (action === "pin-folder") activeManager.togglePinFolder();
  else if (action === "delete-folder") activeManager.deleteFolder();
  else if (action === "add-subfolder") activeManager.addSubfolder();
  else if (action === "pin-subfolder") activeManager.togglePinSubfolder();
  else if (action === "delete-subfolder") activeManager.deleteSubfolder();
  else if (action === "add-bookmark") activeManager.addBookmark();
  else if (action === "edit-bookmark") activeManager.editBookmark();
  else if (action === "delete-bookmark") activeManager.deleteBookmark();
});

// + button adds new section
document.getElementById("addTabBtn").addEventListener("click", () => {
  const title = prompt("Section title:");
  if (!title || !title.trim()) return;
  const cleanTitle = title.trim();
  const base = cleanTitle.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, "");
  const uid = Date.now().toString();
  const id = base + "_" + uid;
  const dbKey = base + "Bookmarks_" + uid;
  sectionsConfig.push({ id, dbKey, title: cleanTitle, order: sectionsConfig.length });
  saveSectionsConfig();
});

document.getElementById("lockBtn").addEventListener("click", () => {
  if (isUnlocked) {
    isUnlocked = false;
    document.getElementById("lockBtn").textContent = "ðŸ”’";
    showEditButtons(false);
  } else {
    const input = prompt("Enter password:");
    if (input === CORRECT_PASSWORD) {
      isUnlocked = true;
      document.getElementById("lockBtn").textContent = "ðŸ”“";
      showEditButtons(true);
    } else if (input !== null) {
      alert("Incorrect password.");
    }
  }
});

// â”€â”€â”€ Listen to section config from Firebase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sectionsRef.on("value", snapshot => {
  const val = snapshot.val();
  let newConfig = [];
  if (val) {
    newConfig = Object.values(val).sort((a, b) => a.order - b.order);
  }
  sectionsConfig = newConfig;
  renderAllSections();
});

function saveSectionsConfig() {
  const obj = {};
  sectionsConfig.forEach((sec, i) => {
    obj[sec.id] = { id: sec.id, dbKey: sec.dbKey, title: sec.title, order: i };
  });
  sectionsRef.set(obj);
}

// â”€â”€â”€ Render all sections â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAllSections() {
  const container = document.getElementById("sectionsContainer");
  const tabsList = document.getElementById("sectionTabsList");
  const emptyMsg = document.getElementById("emptyMsg");

  const existingManagers = {};
  managers.forEach(m => { existingManagers[m.dbKey] = m; });

  const newDbKeys = sectionsConfig.map(s => s.dbKey);
  managers.forEach(m => { if (!newDbKeys.includes(m.dbKey)) m.destroy && m.destroy(); });

  managers = [];
  container.innerHTML = "";
  tabsList.innerHTML = "";

  if (sectionsConfig.length === 0) {
    emptyMsg.style.display = "block";
    showEditButtons(isUnlocked);
    return;
  }

  emptyMsg.style.display = "none";

  sectionsConfig.forEach((sec, idx) => {
    // Create tab
    const tab = document.createElement("div");
    tab.className = "section-tab";
    tab.title = sec.title;
    tab.textContent = sec.title;
    tabsList.appendChild(tab);

    // Create content div (hidden by default)
    const div = document.createElement("div");
    div.id = "sec_" + sec.id;
    div.className = "manager-section";
    div.style.display = "none";
    container.appendChild(div);

    let mgr;
    if (existingManagers[sec.dbKey]) {
      mgr = existingManagers[sec.dbKey];
      mgr.sectionIndex = idx;
      mgr.container = div;
      mgr.tabEl = tab;
      mgr.buildLayout();
      mgr.render(false);
    } else {
      mgr = new BookmarkManager("sec_" + sec.id, sec.dbKey, sec.title, idx);
      mgr.tabEl = tab;
    }
    managers.push(mgr);

    tab.addEventListener("click", () => setActiveManager(mgr));
  });

  showEditButtons(isUnlocked);

  const prevActive = activeManager ? managers.find(m => m.dbKey === activeManager.dbKey) : null;
  setActiveManager(prevActive || managers[0]);
}

// â”€â”€â”€ BookmarkManager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
class BookmarkManager {
  constructor(containerId, dbKey, title, sectionIndex) {
    this.container = document.getElementById(containerId);
    this.dbKey = dbKey;
    this.dbRef = database.ref("bookmarkManagers/" + dbKey);
    this.title = title;
    this.sectionIndex = sectionIndex;
    this.MAX_NAME_LENGTH = 20;

    this.data = null; // null means not yet loaded
    this.pins = { folders: [], subs: {} };
    this.currentFolder = null;
    this.currentSubfolder = null;
    this.selectedBookmarkIndex = null;
    this._listener = null;
    this._pinsListener = null;
    this._dataLoaded = false;
    this._pinsLoaded = false;

    this.pinsRef = database.ref("bookmarkPins/" + dbKey);

    this.buildLayout();
    this.listen();
    this.listenPins();
  }

  destroy() {
    if (this._listener) this.dbRef.off("value", this._listener);
    if (this._pinsListener) this.pinsRef.off("value", this._pinsListener);
  }

  listen() {
    this._listener = this.dbRef.on("value", snapshot => {
      this.data = snapshot.val() || {};
      this._dataLoaded = true;
      if (this._pinsLoaded) {
        this.autoSelectFirst();
      }
      this.render(false);
    });
  }

  listenPins() {
    this._pinsListener = this.pinsRef.on("value", snapshot => {
      const val = snapshot.val();
      this.pins = {
        folders: (val && Array.isArray(val.folders)) ? val.folders : [],
        subs: (val && val.subs && typeof val.subs === "object") ? val.subs : {}
      };
      this._pinsLoaded = true;
      // Always run autoSelectFirst and render when pins update
      if (this._dataLoaded) {
        this.autoSelectFirst();
        this.render(false);
      }
    });

    // Fallback: if pins don't exist in Firebase, listener still fires with null
    // but just in case, force pinsLoaded after short delay
    setTimeout(() => {
      if (!this._pinsLoaded) {
        this._pinsLoaded = true;
        if (this._dataLoaded) {
          this.autoSelectFirst();
          this.render(false);
        }
      }
    }, 2000);
  }

  autoSelectFirst() {
    if (!this.data) return;
    const internalKeys = ["__placeholder__", "__pins__"];
    const folders = Object.keys(this.data).filter(k => !internalKeys.includes(k));
    if (folders.length === 0) return;

    const pins = this.pins.folders || [];
    const pinned = pins.filter(f => folders.includes(f));
    const unpinned = folders.filter(f => !pins.includes(f)).sort((a, b) => a.localeCompare(b));
    const sorted = [...pinned, ...unpinned];

    // Auto-select first folder if not set
    if (!this.currentFolder || !sorted.includes(this.currentFolder)) {
      this.currentFolder = sorted[0];
    }

    // Auto-select first subfolder
    const folderData = this.data[this.currentFolder];
    if (folderData) {
      const internalSubKeys = ["__empty__", "__direct__"];
      const subs = Object.keys(folderData).filter(s => !internalSubKeys.includes(s));
      const subPins = (this.pins.subs && this.pins.subs[this.currentFolder]) || [];
      const pinnedSubs = subPins.filter(s => subs.includes(s));
      const unpinnedSubs = subs.filter(s => !subPins.includes(s)).sort((a, b) => a.localeCompare(b));
      const sortedSubs = [...pinnedSubs, ...unpinnedSubs];

      if (!this.currentSubfolder || !sortedSubs.includes(this.currentSubfolder)) {
        this.currentSubfolder = sortedSubs.length > 0 ? sortedSubs[0] : (folderData["__direct__"] ? "__direct__" : null);
      }
    }
  }

  save() {
    if (this.data === null) return; // not yet loaded, never overwrite
    this.dbRef.set(this.data);
  }

  sanitizeName(name) {
    if (!name) return null;
    name = name.trim();
    if (!name) return null;
    return name.length > this.MAX_NAME_LENGTH
      ? name.substring(0, this.MAX_NAME_LENGTH)
      : name;
  }

  buildLayout() {
    this.container.innerHTML = `
      <div class="tabs"></div>
      <div class="subtabs"></div>
      <div class="bookmarks"></div>
    `;
    this.tabsDiv = this.container.querySelector(".tabs");
    this.subtabsDiv = this.container.querySelector(".subtabs");
    this.bookmarksDiv = this.container.querySelector(".bookmarks");
  }

  // â”€â”€ Section management â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  moveSection(direction) {
    const idx = this.sectionIndex;
    const newIdx = idx + direction;
    if (newIdx < 0 || newIdx >= sectionsConfig.length) return;
    // Swap
    const temp = sectionsConfig[idx];
    sectionsConfig[idx] = sectionsConfig[newIdx];
    sectionsConfig[newIdx] = temp;
    saveSectionsConfig();
  }

  togglePinFolder() {
    if (!this.currentFolder) return alert("Select a folder first.");
    if (!this.pins.folders) this.pins.folders = [];
    const pins = this.pins.folders;
    const idx = pins.indexOf(this.currentFolder);
    if (idx === -1) {
      pins.push(this.currentFolder);
      alert('"' + this.currentFolder + '" folder pinned!');
    } else {
      pins.splice(idx, 1);
      alert('"' + this.currentFolder + '" folder unpinned!');
    }
    this.savePins();
    this.render(false);
  }

  togglePinSubfolder() {
    if (!this.currentFolder) return alert("Select a folder first.");
    if (!this.currentSubfolder || this.currentSubfolder === "__direct__") return alert("Select a subfolder first (not â€” or none).");
    // Make sure subs object exists without touching folders
    if (!this.pins.subs) this.pins.subs = {};
    if (!this.pins.subs[this.currentFolder]) this.pins.subs[this.currentFolder] = [];
    const pins = this.pins.subs[this.currentFolder];
    const idx = pins.indexOf(this.currentSubfolder);
    if (idx === -1) {
      pins.push(this.currentSubfolder);
      alert('"' + this.currentSubfolder + '" subfolder pinned!');
    } else {
      pins.splice(idx, 1);
      alert('"' + this.currentSubfolder + '" subfolder unpinned!');
    }
    this.savePins();
    this.render(false);
  }

  savePins() {
    this.pinsRef.set(this.pins);
  }

  renameSection() {
    const current = sectionsConfig[this.sectionIndex].title;
    const newTitle = prompt("Rename section:", current);
    if (!newTitle || !newTitle.trim() || newTitle.trim() === current) return;
    sectionsConfig[this.sectionIndex].title = newTitle.trim();
    saveSectionsConfig();
    if (this.tabEl) {
      this.tabEl.textContent = newTitle.trim();
      this.tabEl.title = newTitle.trim();
    }
  }

  deleteSection() {
    const title = sectionsConfig[this.sectionIndex].title;
    if (!confirm(`Delete section "${title}"? This will permanently delete all its bookmarks too.`)) return;
    this.dbRef.remove();
    this.pinsRef.remove();
    sectionsConfig.splice(this.sectionIndex, 1);
    saveSectionsConfig();
  }

  // â”€â”€ Bookmark CRUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  render(save = true) {
    if (this.data === null) return; // not yet loaded
    this.renderTabs();
    this.renderSubtabs();
    this.renderBookmarks();
    if (save) this.save();
  }

  renderTabs() {
    this.tabsDiv.innerHTML = "";
    const internalKeys = ["__placeholder__", "__pins__"];
    const folders = Object.keys(this.data).filter(k => !internalKeys.includes(k));
    if (folders.length === 0) return;

    const pins = this.pins.folders || [];

    // Pinned in pin order, unpinned alphabetically after
    const pinned = pins.filter(f => folders.includes(f));
    const unpinned = folders.filter(f => !pins.includes(f)).sort((a, b) => a.localeCompare(b));
    const sorted = [...pinned, ...unpinned];

    if (!this.currentFolder || !sorted.includes(this.currentFolder)) {
      this.currentFolder = sorted[0];
    }

    sorted.forEach(folder => {
      const btn = document.createElement("button");
      const isPinned = pins.includes(folder);
      btn.textContent = (isPinned ? "ðŸ“Œ " : "") + folder;
      if (folder === this.currentFolder) btn.classList.add("active");
      btn.onclick = () => {
        this.currentFolder = folder;
        this.currentSubfolder = null;
        this.selectedBookmarkIndex = null;
        this.render();
      };
      this.tabsDiv.appendChild(btn);
    });
  }

  renderSubtabs() {
    this.subtabsDiv.innerHTML = "";
    if (!this.currentFolder) return;

    const folderData = this.data[this.currentFolder];
    const internalKeys = ["__empty__", "__direct__"];
    const subPins = (this.pins.subs && this.pins.subs[this.currentFolder]) || [];

    // Real subfolders
    const subs = Object.keys(folderData).filter(s => !internalKeys.includes(s));

    // Pinned first, then rest alphabetically
    const pinnedSubs = subPins.filter(s => subs.includes(s));
    const unpinnedSubs = subs.filter(s => !subPins.includes(s)).sort((a, b) => a.localeCompare(b));
    const sortedSubs = [...pinnedSubs, ...unpinnedSubs];

    // Build tab list: direct first if has bookmarks, then sorted subs
    const tabs = [];
    const directLinks = folderData["__direct__"];
    if (Array.isArray(directLinks) && directLinks.some(l => typeof l === "object" && l !== null && !l.__placeholder__)) {
      tabs.push("__direct__");
    }
    tabs.push(...sortedSubs);

    if (tabs.length === 0) {
      this.currentSubfolder = null;
      return;
    }

    if (!this.currentSubfolder || !tabs.includes(this.currentSubfolder)) {
      this.currentSubfolder = tabs[0];
    }

    tabs.forEach(sub => {
      const isPinned = subPins.includes(sub);
      const btn = document.createElement("button");
      btn.textContent = sub === "__direct__" ? "â€”" : (isPinned ? "ðŸ“Œ " : "") + sub;
      if (sub === this.currentSubfolder) btn.classList.add("active");
      btn.onclick = () => {
        this.currentSubfolder = sub;
        this.selectedBookmarkIndex = null;
        this.renderSubtabs();
        this.renderBookmarks();
      };
      this.subtabsDiv.appendChild(btn);
    });
  }

  renderBookmarks() {
    this.bookmarksDiv.innerHTML = "";
    if (!this.currentFolder || !this.currentSubfolder) return;

    const allLinks = this.data[this.currentFolder][this.currentSubfolder];
    // Map with real indices before filtering out placeholders
    const links = Array.isArray(allLinks)
      ? allLinks
          .map((l, realIndex) => ({ link: l, realIndex }))
          .filter(({ link }) => typeof link === "object" && link !== null && !link.__placeholder__)
      : [];

    links.forEach(({ link, realIndex }) => {
      const div = document.createElement("div");
      div.className = "bookmark-item";

      const favicon = document.createElement("img");
      favicon.src =
        "https://www.google.com/s2/favicons?sz=32&domain_url=" + link.url;

      div.onclick = () => {
        this.selectedBookmarkIndex = realIndex;
        this.bookmarksDiv
          .querySelectorAll(".bookmark-item")
          .forEach(el => el.classList.remove("selected"));
        div.classList.add("selected");
      };

      const a = document.createElement("a");
      a.href = link.url;
      a.target = "_self";
      a.textContent = link.name;

      favicon.style.pointerEvents = "none";
      div.appendChild(favicon);
      div.appendChild(a);
      this.bookmarksDiv.appendChild(div);
    });
  }

  addFolder() {
    let name = this.sanitizeName(prompt("Folder name:"));
    if (!name || this.data[name]) return;
    this.data[name] = { "__empty__": true };
    this.currentFolder = name;
    this.currentSubfolder = null;
    this.render();
  }

  deleteFolder() {
    if (!this.currentFolder) return;
    if (confirm("Delete folder?")) {
      delete this.data[this.currentFolder];
      this.currentFolder = null;
      this.currentSubfolder = null;
      this.selectedBookmarkIndex = null;
      this.render();
    }
  }

  addSubfolder() {
    if (!this.currentFolder) return;
    let name = this.sanitizeName(prompt("Subfolder name:"));
    if (!name || this.data[this.currentFolder][name]) return;
    this.data[this.currentFolder][name] = [{ "__placeholder__": true }];
    this.currentSubfolder = name;
    // Remove folder's empty placeholder now it has a subfolder
    if (this.data[this.currentFolder]["__empty__"]) {
      delete this.data[this.currentFolder]["__empty__"];
    }
    this.render();
  }

  deleteSubfolder() {
    if (!this.currentSubfolder) return;
    if (confirm("Delete subfolder?")) {
      delete this.data[this.currentFolder][this.currentSubfolder];
      this.currentSubfolder = null;
      this.selectedBookmarkIndex = null;
      this.render();
    }
  }

  addBookmark() {
    if (!this.currentFolder) return alert("Select a folder first.");
    const name = prompt("Bookmark name:");
    const url = prompt("Bookmark URL:");
    if (!name || !url) return;

    // Add directly to folder if no subfolder selected, using __direct__ key
    const target = this.currentSubfolder || "__direct__";
    if (!this.data[this.currentFolder][target]) {
      this.data[this.currentFolder][target] = [];
    }
    // Remove any placeholder entries
    this.data[this.currentFolder][target] =
      this.data[this.currentFolder][target].filter(l => typeof l === "object" && l !== null && !l.__placeholder__);
    this.data[this.currentFolder][target].push({ name, url });
    // Remove folder-level __empty__ placeholder
    if (this.data[this.currentFolder]["__empty__"]) {
      delete this.data[this.currentFolder]["__empty__"];
    }
    // Set currentSubfolder so it shows up selected
    this.currentSubfolder = target;
    this.render();
  }

  editBookmark() {
    if (this.selectedBookmarkIndex === null)
      return alert("Select a bookmark first.");

    const sub = this.currentSubfolder || "__direct__";
    const links = this.data[this.currentFolder][sub];
    if (!links || this.selectedBookmarkIndex >= links.length)
      return alert("Invalid selection. Please select again.");

    const link = links[this.selectedBookmarkIndex];
    const name = prompt("New name:", link.name);
    const url = prompt("New URL:", link.url);
    if (!name || !url) return;

    link.name = name;
    link.url = url;
    this.render();
  }

  deleteBookmark() {
    if (this.selectedBookmarkIndex === null)
      return alert("Select a bookmark first.");

    const sub = this.currentSubfolder || "__direct__";
    const links = this.data[this.currentFolder][sub];
    if (!links || this.selectedBookmarkIndex >= links.length)
      return alert("Invalid selection. Please select again.");

    if (confirm("Delete bookmark?")) {
      links.splice(this.selectedBookmarkIndex, 1);
      // If no bookmarks left, restore placeholder so Firebase keeps the key
      if (links.length === 0) {
        if (sub === "__direct__") {
          delete this.data[this.currentFolder]["__direct__"];
          this.currentSubfolder = null;
        } else {
          this.data[this.currentFolder][sub] = [{ "__placeholder__": true }];
        }
      }
      this.selectedBookmarkIndex = null;
      this.render();
    }
  }
}

// â”€â”€â”€ Sticky offset calculator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateStickyOffsets() {
  const lockBarH = document.getElementById("lockBar").offsetHeight;
  const toolbarEl = document.getElementById("sharedToolbar");
  const tabBarEl = document.getElementById("sectionTabBar");
  const toolbarVisible = toolbarEl.style.display !== "none";
  toolbarEl.style.top = lockBarH + "px";
  const toolbarH = toolbarVisible ? toolbarEl.offsetHeight : 0;
  tabBarEl.style.top = (lockBarH + toolbarH) + "px";
  tabBarEl.style.position = "sticky";
  tabBarEl.style.zIndex = "98";
}
window.addEventListener("resize", updateStickyOffsets);
// Run after render
setTimeout(updateStickyOffsets, 100);

// â”€â”€â”€ Data Manager â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("dataManagerBtn").addEventListener("click", () => {
  openDataManager();
});

document.getElementById("dataManagerClose").addEventListener("click", () => {
  document.getElementById("dataManagerOverlay").style.display = "none";
});

document.getElementById("dataManagerOverlay").addEventListener("click", (e) => {
  if (e.target === document.getElementById("dataManagerOverlay")) {
    document.getElementById("dataManagerOverlay").style.display = "none";
  }
});

function openDataManager() {
  const list = document.getElementById("dataManagerList");
  list.innerHTML = "<div class='dm-empty'>Loading...</div>";
  document.getElementById("dataManagerOverlay").style.display = "flex";

  // Fetch all bookmark data keys from Firebase
  database.ref("bookmarkManagers").once("value", snapshot => {
    const val = snapshot.val();
    list.innerHTML = "";

    if (!val || Object.keys(val).length === 0) {
      list.innerHTML = "<div class='dm-empty'>No bookmark data found in Firebase.</div>";
      return;
    }

    Object.keys(val).forEach(dbKey => {
      const data = val[dbKey];

      // Count folders, subfolders, bookmarks
      const internalKeys = ["__pins__", "__placeholder__", "__empty__", "__direct__"];
      const folders = Object.keys(data).filter(k => !internalKeys.includes(k));
      let subCount = 0, bmCount = 0;
      folders.forEach(f => {
        const folderData = data[f];
        const subs = Object.keys(folderData).filter(s => !internalKeys.includes(s));
        subCount += subs.length;
        subs.forEach(s => {
          const links = folderData[s];
          if (Array.isArray(links)) {
            bmCount += links.filter(l => typeof l === "object" && l !== null && !l.__placeholder__).length;
          }
        });
        // Count direct bookmarks
        if (folderData["__direct__"] && Array.isArray(folderData["__direct__"])) {
          bmCount += folderData["__direct__"].filter(l => typeof l === "object" && l !== null && !l.__placeholder__).length;
        }
      });

      // Find matching section title if any
      const matchedSection = sectionsConfig.find(s => s.dbKey === dbKey);
      const displayTitle = matchedSection ? matchedSection.title : dbKey;
      const isOrphan = !matchedSection;

      const item = document.createElement("div");
      item.className = "dm-item";
      item.innerHTML = `
        <div class="dm-item-info">
          <span class="dm-item-title">${displayTitle} ${isOrphan ? '<span style="color:#e90;font-size:11px;">(orphan)</span>' : ''}</span>
          <span class="dm-item-meta">${folders.length} folder(s) Â· ${subCount} subfolder(s) Â· ${bmCount} bookmark(s)</span>
        </div>
        <button class="dm-delete-btn" data-key="${dbKey}">ðŸ—‘ Delete</button>
      `;

      item.querySelector(".dm-delete-btn").addEventListener("click", () => {
        const label = isOrphan ? dbKey : displayTitle;
        if (!confirm(`Permanently delete all data for "${label}"?`)) return;
        database.ref("bookmarkManagers/" + dbKey).remove();
        database.ref("bookmarkPins/" + dbKey).remove();
        // Also remove from sectionsConfig if present
        if (matchedSection) {
          const idx = sectionsConfig.indexOf(matchedSection);
          if (idx !== -1) sectionsConfig.splice(idx, 1);
          saveSectionsConfig();
        }
        item.remove();
        if (list.children.length === 0) {
          list.innerHTML = "<div class='dm-empty'>No bookmark data found in Firebase.</div>";
        }
      });

      list.appendChild(item);
    });
  });
}


</script>
</body>
</html>
