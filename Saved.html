<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RJ's Bookmark Manager</title>
<link rel="icon" href="/Pages/favicon.png" />    
  
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  font-size: 17px;
  background: #fafafa;
}

.manager-section {
  margin: 30px;
  border: 1px solid #ddd;
  border-radius: 6px;
  background: white;
}

.manager-title-bar {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #ddd;
  background: #f5f5f5;
  gap: 10px;
}

.manager-title {
  font-size: 20px;
  font-weight: bold;
  flex: 1;
  user-select: none;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 300px;
  cursor: pointer;
}

.section-btns {
  margin-left: auto;
  display: none;
  gap: 6px;
  flex-shrink: 0;
}

.manager-title-edit {
  font-size: 20px;
  font-weight: bold;
  flex: 1;
  border: 1px solid #aaa;
  border-radius: 4px;
  padding: 2px 8px;
  outline: none;
}

.section-action-btn {
  background: none;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  font-size: 16px;
  padding: 4px 10px;
  color: #555;
  display: none;
}



.section-action-btn:hover {
  background: #e0e0e0;
}

.section-action-btn.danger:hover {
  background: #fde;
  border-color: #f99;
  color: #c00;
}

.actions {
  display: flex;
  overflow-x: auto;
  white-space: nowrap;
  background: #f5f5f5;
  border-bottom: 1px solid #ddd;
}

.actions button {
  padding: 12px 18px;
  border: none;
  background: none;
  cursor: pointer;
  flex: 0 0 auto;
  font-size: 16px;
  display: none;
}

.actions button:hover {
  background: #ddd;
}

.tabs, .subtabs {
  display: flex;
  overflow-x: auto;
  white-space: nowrap;
  background: #f5f5f5;
  border-bottom: 1px solid #ddd;
}

.tabs button, .subtabs button {
  padding: 12px 18px;
  border: none;
  background: none;
  cursor: pointer;
  flex: 0 0 auto;
  max-width: 220px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 17px;
}

.tabs button.active, .subtabs button.active {
  background: #ddd;
  font-weight: bold;
}

.bookmarks {
  padding: 18px;
  max-height: 240px;
  overflow-y: auto;
}

.bookmark-item {
  display: flex;
  align-items: center;
  padding: 10px;
  border-radius: 4px;
}

.bookmark-item:hover {
  background: #f0f0f0;
}

.bookmark-item.selected {
  background: #d0e6ff;
}

.bookmark-item img {
  margin-right: 10px;
  cursor: pointer;
  width: 20px;
  height: 20px;
}

.bookmark-item a {
  text-decoration: none;
  color: #0077cc;
  font-size: 20px;
  font-weight: bold;
}

#addSectionBtn {
  display: none;
  margin: 0 30px 30px 30px;
  padding: 12px 24px;
  font-size: 16px;
  background: #f5f5f5;
  border: 1px dashed #bbb;
  border-radius: 6px;
  cursor: pointer;
  color: #555;
  width: calc(100% - 60px);
  box-sizing: border-box;
  text-align: center;
}

#addSectionBtn:hover {
  background: #e8e8e8;
  color: #222;
}

#emptyMsg {
  text-align: center;
  color: #aaa;
  padding: 40px 30px 10px 30px;
  font-size: 16px;
  display: none;
}

/* Lock bar at top */
#lockBar {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 8px 30px;
  background: #f0f0f0;
  border-bottom: 1px solid #ddd;
  gap: 10px;
}

#pageTitle {
  font-size: 18px;
  font-weight: bold;
  color: #333;
  margin-right: auto;
}

#lockBar span {
  font-size: 14px;
  color: #888;
}

#lockBtn {
  padding: 6px 14px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: white;
  cursor: pointer;
}

#lockBtn:hover {
  background: #e8e8e8;
}
</style>
</head>

<body>

<div id="lockBar">
  <img src="/Pages/favicon.png" style="width:32px;height:32px;border-radius:6px;object-fit:cover;"> <span id="pageTitle">RJ's Bookmark Manager</span>
  <span id="lockStatus">üîí Locked</span>
  <button id="lockBtn">Unlock</button>
</div>

<div id="sectionsContainer"></div>
<p id="emptyMsg">No sections yet. Add one below!</p>
<button id="addSectionBtn">+ Add New Section</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA5iLF-J-WvNaYm63r8rDZU8_rtZsgwYng",
  authDomain: "my-todo-2e111.firebaseapp.com",
  databaseURL: "https://my-todo-2e111-default-rtdb.firebaseio.com",
  projectId: "my-todo-2e111",
  storageBucket: "my-todo-2e111.appspot.com",
  messagingSenderId: "765517702108",
  appId: "1:765517702108:web:2dfe7d6205040cfd2ea519"
};

firebase.initializeApp(firebaseConfig);
const database = firebase.database();

const sectionsRef = database.ref("sectionConfig");

let sectionsConfig = [];
let managers = [];

// ‚îÄ‚îÄ‚îÄ Session Lock ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CORRECT_PASSWORD = "6409";
let isUnlocked = false;

function showEditButtons(visible) {
  document.querySelectorAll(".actions button").forEach(btn => {
    btn.style.display = visible ? "inline-block" : "none";
  });
  document.querySelectorAll(".section-action-btn").forEach(btn => {
    btn.style.display = visible ? "inline-block" : "none";
  });
  document.querySelectorAll(".section-btns").forEach(div => {
    div.style.display = visible ? "flex" : "none";
  });
  document.getElementById("addSectionBtn").style.display = visible ? "block" : "none";
}

document.getElementById("lockBtn").addEventListener("click", () => {
  if (isUnlocked) {
    // Lock
    isUnlocked = false;
    document.getElementById("lockStatus").textContent = "üîí Locked";
    document.getElementById("lockBtn").textContent = "Unlock";
    showEditButtons(false);
  } else {
    // Unlock
    const input = prompt("Enter password:");
    if (input === CORRECT_PASSWORD) {
      isUnlocked = true;
      document.getElementById("lockStatus").textContent = "üîì Unlocked";
      document.getElementById("lockBtn").textContent = "Lock";
      showEditButtons(true);
    } else if (input !== null) {
      alert("Incorrect password.");
    }
  }
});

// ‚îÄ‚îÄ‚îÄ Listen to section config from Firebase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
sectionsRef.on("value", snapshot => {
  const val = snapshot.val();
  let newConfig = [];
  if (val) {
    newConfig = Object.values(val).sort((a, b) => a.order - b.order);
  }
  // Only re-render if sections actually changed (added, removed, renamed, reordered)
  const oldSig = JSON.stringify(sectionsConfig.map(s => s.id + s.title + s.order));
  const newSig = JSON.stringify(newConfig.map(s => s.id + s.title + s.order));
  sectionsConfig = newConfig;
  if (oldSig !== newSig) {
    renderAllSections();
  }
});

function saveSectionsConfig() {
  const obj = {};
  sectionsConfig.forEach((sec, i) => {
    obj[sec.id] = { id: sec.id, dbKey: sec.dbKey, title: sec.title, order: i };
  });
  sectionsRef.set(obj);
}

// ‚îÄ‚îÄ‚îÄ Render all sections ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAllSections() {
  const container = document.getElementById("sectionsContainer");
  const emptyMsg = document.getElementById("emptyMsg");

  managers.forEach(m => m.destroy && m.destroy());
  managers = [];
  container.innerHTML = "";

  if (sectionsConfig.length === 0) {
    emptyMsg.style.display = "block";
  } else {
    emptyMsg.style.display = "none";
    sectionsConfig.forEach((sec, idx) => {
      const div = document.createElement("div");
      div.id = "sec_" + sec.id;
      div.className = "manager-section";
      container.appendChild(div);

      const mgr = new BookmarkManager("sec_" + sec.id, sec.dbKey, sec.title, idx);
      managers.push(mgr);
    });
  }

  // Re-apply lock state after re-render
  showEditButtons(isUnlocked);
}

// ‚îÄ‚îÄ‚îÄ BookmarkManager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class BookmarkManager {
  constructor(containerId, dbKey, title, sectionIndex) {
    this.container = document.getElementById(containerId);
    this.dbKey = dbKey;
    this.dbRef = database.ref("bookmarkManagers/" + dbKey);
    this.title = title;
    this.sectionIndex = sectionIndex;
    this.MAX_NAME_LENGTH = 20;

    this.data = null; // null means not yet loaded
    this.currentFolder = null;
    this.currentSubfolder = null;
    this.selectedBookmarkIndex = null;
    this._listener = null;

    this.buildLayout();
    this.listen();
  }

  destroy() {
    if (this._listener) {
      this.dbRef.off("value", this._listener);
    }
  }

  listen() {
    this._listener = this.dbRef.on("value", snapshot => {
      this.data = snapshot.val() || {};
      this.render(false);
    });
  }

  save() {
    if (this.data === null) return; // not yet loaded, never overwrite
    this.dbRef.set(this.data);
  }

  sanitizeName(name) {
    if (!name) return null;
    name = name.trim();
    if (!name) return null;
    return name.length > this.MAX_NAME_LENGTH
      ? name.substring(0, this.MAX_NAME_LENGTH)
      : name;
  }

  buildLayout() {
    this.container.innerHTML = `
      <div class="manager-title-bar">
        <span class="manager-title">${this.title}</span>
        <div class="section-btns">
          <button class="section-action-btn" data-action="rename" title="Rename section">‚úèÔ∏è</button>
          <button class="section-action-btn danger" data-action="delete-section" title="Delete section">üóë</button>
        </div>
      </div>
      <div class="actions"></div>
      <div class="tabs"></div>
      <div class="subtabs"></div>
      <div class="bookmarks"></div>
    `;

    this.actionsDiv = this.container.querySelector(".actions");
    this.tabsDiv = this.container.querySelector(".tabs");
    this.subtabsDiv = this.container.querySelector(".subtabs");
    this.bookmarksDiv = this.container.querySelector(".bookmarks");
    this.titleEl = this.container.querySelector(".manager-title");

    // Show full title on click if truncated
    this.titleEl.addEventListener("click", () => {
      if (this.titleEl.scrollWidth > this.titleEl.clientWidth) {
        alert(sectionsConfig[this.sectionIndex].title);
      }
    });

    this.container.querySelector("[data-action='rename']")
      .addEventListener("click", () => this.renameSection());

    this.container.querySelector("[data-action='delete-section']")
      .addEventListener("click", () => this.deleteSection());

    this.buildMenu();
  }

  // ‚îÄ‚îÄ Section management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  renameSection() {
    const current = sectionsConfig[this.sectionIndex].title;
    const newTitle = prompt("Rename section:", current);
    if (!newTitle || !newTitle.trim() || newTitle.trim() === current) return;
    sectionsConfig[this.sectionIndex].title = newTitle.trim();
    saveSectionsConfig();
    this.titleEl.textContent = newTitle.trim();
  }

  deleteSection() {
    const title = sectionsConfig[this.sectionIndex].title;
    if (!confirm(`Delete section "${title}"?\n\nNote: Bookmark data in Firebase will NOT be deleted.`)) return;
    sectionsConfig.splice(this.sectionIndex, 1);
    saveSectionsConfig();
  }

  // ‚îÄ‚îÄ Bookmark CRUD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  buildMenu() {
    const actions = [
      ["Add Folder", () => this.addFolder()],
      ["Delete Folder", () => this.deleteFolder()],
      ["Add Subfolder", () => this.addSubfolder()],
      ["Delete Subfolder", () => this.deleteSubfolder()],
      ["Add Bookmark", () => this.addBookmark()],
      ["Edit Bookmark", () => this.editBookmark()],
      ["Delete Bookmark", () => this.deleteBookmark()]
    ];

    this.actionsDiv.innerHTML = "";
    actions.forEach(([label, action]) => {
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.onclick = action;
      this.actionsDiv.appendChild(btn);
    });
  }

  render(save = true) {
    this.renderTabs();
    this.renderSubtabs();
    this.renderBookmarks();
    if (save) this.save();
  }

  renderTabs() {
    this.tabsDiv.innerHTML = "";
    const folders = Object.keys(this.data);
    if (folders.length === 0) return;

    // Auto-select first folder if none selected or current no longer exists
    if (!this.currentFolder || !folders.includes(this.currentFolder)) {
      this.currentFolder = folders[0];
    }

    folders.forEach(folder => {
      const btn = document.createElement("button");
      btn.textContent = folder;
      if (folder === this.currentFolder) btn.classList.add("active");
      btn.onclick = () => {
        this.currentFolder = folder;
        this.currentSubfolder = null;
        this.selectedBookmarkIndex = null;
        this.render();
      };
      this.tabsDiv.appendChild(btn);
    });
  }

  renderSubtabs() {
    this.subtabsDiv.innerHTML = "";
    if (!this.currentFolder) return;

    const subs = Object.keys(this.data[this.currentFolder]);
    if (subs.length === 0) return;

    // Auto-select first subfolder if none selected or current no longer exists
    if (!this.currentSubfolder || !subs.includes(this.currentSubfolder)) {
      this.currentSubfolder = subs[0];
    }

    subs.forEach(sub => {
      const btn = document.createElement("button");
      btn.textContent = sub;
      if (sub === this.currentSubfolder) btn.classList.add("active");
      btn.onclick = () => {
        this.currentSubfolder = sub;
        this.selectedBookmarkIndex = null;
        this.renderSubtabs();
        this.renderBookmarks();
      };
      this.subtabsDiv.appendChild(btn);
    });
  }

  renderBookmarks() {
    this.bookmarksDiv.innerHTML = "";
    if (!this.currentSubfolder) return;

    const links = this.data[this.currentFolder][this.currentSubfolder];

    links.forEach((link, index) => {
      const div = document.createElement("div");
      div.className = "bookmark-item";

      const favicon = document.createElement("img");
      favicon.src =
        "https://www.google.com/s2/favicons?sz=32&domain_url=" + link.url;

      favicon.onclick = () => {
        this.selectedBookmarkIndex = index;
        this.bookmarksDiv
          .querySelectorAll(".bookmark-item")
          .forEach(el => el.classList.remove("selected"));
        div.classList.add("selected");
      };

      const a = document.createElement("a");
      a.href = link.url;
      a.target = "_blank";
      a.textContent = link.name;

      div.appendChild(favicon);
      div.appendChild(a);
      this.bookmarksDiv.appendChild(div);
    });
  }

  addFolder() {
    let name = this.sanitizeName(prompt("Folder name:"));
    if (!name || this.data[name]) return;
    this.data[name] = {};
    this.currentFolder = name;
    this.currentSubfolder = null;
    this.render();
  }

  deleteFolder() {
    if (!this.currentFolder) return;
    if (confirm("Delete folder?")) {
      delete this.data[this.currentFolder];
      this.currentFolder = null;
      this.currentSubfolder = null;
      this.selectedBookmarkIndex = null;
      this.render();
    }
  }

  addSubfolder() {
    if (!this.currentFolder) return;
    let name = this.sanitizeName(prompt("Subfolder name:"));
    if (!name || this.data[this.currentFolder][name]) return;
    this.data[this.currentFolder][name] = [];
    this.currentSubfolder = name;
    this.render();
  }

  deleteSubfolder() {
    if (!this.currentSubfolder) return;
    if (confirm("Delete subfolder?")) {
      delete this.data[this.currentFolder][this.currentSubfolder];
      this.currentSubfolder = null;
      this.selectedBookmarkIndex = null;
      this.render();
    }
  }

  addBookmark() {
    if (!this.currentSubfolder) return;
    const name = prompt("Bookmark name:");
    const url = prompt("Bookmark URL:");
    if (!name || !url) return;
    this.data[this.currentFolder][this.currentSubfolder].push({ name, url });
    this.render();
  }

  editBookmark() {
    if (this.selectedBookmarkIndex === null)
      return alert("Select a bookmark first.");

    const links = this.data[this.currentFolder][this.currentSubfolder];
    if (this.selectedBookmarkIndex >= links.length)
      return alert("Invalid selection. Please select again.");

    const link = links[this.selectedBookmarkIndex];
    const name = prompt("New name:", link.name);
    const url = prompt("New URL:", link.url);
    if (!name || !url) return;

    link.name = name;
    link.url = url;
    this.render();
  }

  deleteBookmark() {
    if (this.selectedBookmarkIndex === null)
      return alert("Select a bookmark first.");

    const links = this.data[this.currentFolder][this.currentSubfolder];
    if (this.selectedBookmarkIndex >= links.length)
      return alert("Invalid selection. Please select again.");

    if (confirm("Delete bookmark?")) {
      links.splice(this.selectedBookmarkIndex, 1);
      this.selectedBookmarkIndex = null;
      this.render();
    }
  }
}

// ‚îÄ‚îÄ‚îÄ Add Section ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById("addSectionBtn").addEventListener("click", () => {
  const title = prompt("Section title:");
  if (!title || !title.trim()) return;

  const cleanTitle = title.trim();
  const base = cleanTitle.toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, "");
  const uid = Date.now().toString();
  const id = base + "_" + uid;
  const dbKey = base + "Bookmarks_" + uid;

  sectionsConfig.push({ id, dbKey, title: cleanTitle, order: sectionsConfig.length });
  saveSectionsConfig();
});
</script>
</body>
</html>
